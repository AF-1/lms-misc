-- PlaylistName:* UNrated by GENRE (with % of RATED songs)
-- PlaylistGroups:
-- PlaylistParameter1:genre:Select genre:
-- PlaylistParameter2:list:Select percentage of RATED Songs:0:0%,10:10%,20:20%,30:30%,40:40%,50:50%,60:60%,70:70%,80:80%,90:90%,100:100%

DROP TABLE IF EXISTS randomweightedratingsrated;
DROP TABLE IF EXISTS randomweightedratingsunrated;
DROP TABLE IF EXISTS randomweightedratingscombined;

create temporary table randomweightedratingsunrated as select tracks.url as url from tracks
	join genre_track on
		tracks.id=genre_track.track
	join genres on
		genre_track.genre=genres.id
		and genre_track.genre='PlaylistParameter1'
	join tracks_persistent on
		tracks.url=tracks_persistent.url and (tracks_persistent.rating = 0 or tracks_persistent.rating is null) 
	left join comments as excludecomments on
		tracks.id=excludecomments.track and excludecomments.value like '%%never%%'
	left join dynamicplaylist_history on
		tracks.id=dynamicplaylist_history.id and dynamicplaylist_history.client='PlaylistPlayer'
	where
		audio=1
		and excludecomments.id is null
		and tracks.secs>90
		and dynamicplaylist_history.id is null
	order by random()
	limit (100-'PlaylistParameter2');


create temporary table randomweightedratingsrated as select tracks.url as url from tracks
	join genre_track on
		tracks.id=genre_track.track
	join genres on
		genre_track.genre=genres.id
		and genre_track.genre='PlaylistParameter1'
	join tracks_persistent on
		tracks.url=tracks_persistent.url and tracks_persistent.rating > 0
	left join comments as excludecomments on
		tracks.id=excludecomments.track and excludecomments.value like '%%never%%'
	left join dynamicplaylist_history on
		tracks.id=dynamicplaylist_history.id and dynamicplaylist_history.client='PlaylistPlayer'
	where
		audio=1
		and excludecomments.id is null
		and tracks.secs>90
		and dynamicplaylist_history.id is null
	order by random()
	limit 'PlaylistParameter2';

create temporary table randomweightedratingscombined as 
	SELECT * FROM randomweightedratingsunrated 
	UNION 
	SELECT * from randomweightedratingsrated;

SELECT * from randomweightedratingscombined 
	ORDER BY random() 
	limit 20;

DROP TABLE randomweightedratingsrated;
DROP TABLE randomweightedratingsunrated;
DROP TABLE randomweightedratingscombined;
